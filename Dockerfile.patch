# Patch Dockerfile - only copy modified Python files
FROM rayproject/ray:2.50.1-py39

USER root

# Create temp directory for our files
WORKDIR /tmp/ray-patches

# Copy only the specific Python files we modified (not .so files!)
COPY python/ray/train/_internal/jit_checkpoint.py ./jit_checkpoint.py
COPY python/ray/train/_internal/jit_checkpoint_config.py ./jit_checkpoint_config.py
COPY python/ray/train/_internal/backend_executor.py ./backend_executor.py
COPY python/ray/train/_internal/session.py ./session.py
COPY python/ray/train/data_parallel_trainer.py ./data_parallel_trainer.py
COPY python/ray/train/trainer.py ./trainer.py
COPY python/ray/train/v2/api/config.py ./config.py

# Install the patched files
RUN cp jit_checkpoint.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/_internal/ && \
    cp jit_checkpoint_config.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/_internal/ && \
    cp backend_executor.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/_internal/ && \
    cp session.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/_internal/ && \
    cp data_parallel_trainer.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/ && \
    cp trainer.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/ && \
    cp config.py /home/ray/anaconda3/lib/python3.9/site-packages/ray/train/v2/api/

# Verify JIT checkpoint is available
RUN python -c "from ray.train._internal.jit_checkpoint import JITCheckpointHandler; print('✓ JIT Checkpoint Handler available')" && \
    python -c "from ray.train._internal.jit_checkpoint_config import JITCheckpointConfig; print('✓ JIT Checkpoint Config available')" && \
    python -c "from ray.train._internal.jit_checkpoint_config import JITCheckpointConfig; config = JITCheckpointConfig(enabled=True, kill_wait=3.0); print(f'✓ Config test: enabled={config.enabled}, kill_wait={config.kill_wait}')"

# Clean up
RUN rm -rf /tmp/ray-patches

USER ray
WORKDIR /home/ray

CMD ["ray", "start", "--head", "--block"]
